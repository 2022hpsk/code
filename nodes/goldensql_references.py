import json
import re
from pathlib import Path
from utils import call_sse

prompt = f"""
# 任务
给定一个新的 NL2SQL 问题，请从“examples”中选择最能借鉴的三个已有 NL2SQL 示例。
先给出简要的思考过程（为什么选择这三个），最后只输出一行：
sql_ids = [id1,id2,id3]

# 要求
- 只输出整数 id，不要带前缀“sql”，例如从“sql28”输出 28
- 必须且仅有 3 个唯一 id
- 最后一行严格遵循格式：sql_ids = [x,y,z]

# examples（候选的已有 NL2SQL，带有示例键名便于识别）
sql_28:"统计各个玩法上线首周留存情况\n输出：玩法、上线首周首次玩的日期、第几天留存（0,1,2...7)、玩法留存用户数\n\n各玩法首周上线日期：\n\"广域战场\": \"20240723\",\n\"消灭战\": \"20230804\",\n\"幻想混战\": \"20241115\",\n\"荒野传说\": \"20240903\",\n\"策略载具\": \"20241010\",\n\"炎夏混战\": \"20240625\",\n\"单人装备\": \"20240517\",\n\"交叉堡垒\": \"20240412\""

sql_30:"统计2019.5.8至2025.3.30 分月的玩法主玩情况\n输出：月份(201905、201906、...、202503)、主玩玩法、主玩人数、总参与人数"

sql_33:"统计2024年12月14日-2024年12月20日参与建筑争夺玩法的玩家人数（去重）有多少，其中多少人是12月13日及以前有参与过建筑争夺的老玩家，有多少是新玩家\n输出: 玩家人数、老玩家人数、新玩家人数"

sql_34:"统计2024.9.17-2024.9.23 和 2024.10.8-2024.10.14    每天点击按钮后加入玩法，再之后点击确认的人数，以及这些人加入玩法的次数\n输出：日期(20240917、...、20240923、20241008、...、20241014)，人数，人次"

sql_35:"统计2024年3月26日~4月3日\n2024年5月28日~6月5日\n不同对局类型的游戏和玩法留存情况\n输出：统计日期(20240326、...、20240403、20240528、...、20240605)、对局类型（第一人称、单排、双排、四排），每日对局人数、次数、对局总时长(秒)、游戏次留人数、游戏7留人数，玩法次留人数、玩法7留人数"

sql_37:"统计注册日期在2025.4.1-2025.5.30的模拟器新进用户在用户类型（模拟器、手机端、整体砺刃游戏内），次留、三留、七留、14留、30留情况\n输出:日期(20250401、...、20250530)、人数、用户类型（模拟器、手机端、游戏内、未知）、次留人数、三留人数、七留人数、14留人数、30留人数"

sql_38:"统计不同玩法不同用户类型的参与情况\n\n输出：玩法、用户类型（砺刃新增、砺刃回流（流失60天以上）、砺刃回流（流失21-59天）、砺刃回流（流失14-20天）、砺刃回流（流失7-13天）、砺刃留存、平台盘内、平台盘外）、上线后3天参与用户数、上线后3天总用户数\n\n各玩法上线日期：\n\"广域战场\": \"20240723\",\n\"消灭战\": \"20230804\",\n\"幻想混战\": \"20241115\",\n\"荒野传说\": \"20240903\",\n\"策略载具\": \"20241010\",\n\"炎夏混战\": \"20240625\",\n\"单人装备\": \"20240517\",\n\"交叉堡垒\": \"20240412\""

sql_39:"\n统计各个玩法参与用户其他玩法流入和双栖情况\n\n输出：流入玩法、流出玩法、上线后3天流入玩法参与用户数、上线后3天流出用户数、上线后3天双栖用户数、上线前一周流出玩法总参与用户数、流出占比、上线后3天流出玩法总参与用户数、双栖占比\n"

sql_45:"统计2024.01.01-2024.01.07参与乐园子玩法拼图狂欢在202401.08-2024.01.14没玩乐园子玩法拼图狂欢在2024.01.15-2024.01.21又玩了乐园子玩法拼图狂欢的用户\n输出：玩家数"

sql_46:"统计2024.1.1-2024.2.2期间，每个自然周不同周活跃天数玩家数\n输出：统计周(1、2、3...、5)、周活跃天数、玩家数"

sql_48:"统计2023.12.1流失7天的回流用户数和流失30天的回流用户数\n输出：流失7天的回流用户数，流失30天的回流用户数"

sql_49:"2024年10月1-2024年10月7 用周期开始时间判断玩法上线时间在7天及以上，周期结束时间判断玩法上线时间在90天及以内的玩法，统计周期内这些玩法的参与和留存情况\n输出：周期(20241001-20241007)，日期(20241001、...、20241007)，参与人数，次留人数"

sql_56:"时间：2024.01.01-2024.01.31\n每日新增用户的LTV，LTV1~LTV10\n输出：注册日期(20240101、20240102、...、20240131)、新进用户数、LTV1、LTV3、LTV7、LTV14、LTV30、LTV60、LTV90、LTV180\n"

sql_57:"统计限定抽取阶梯活动每天的pv和角色数\n活动日期\t2024.11.29-12.19\t\n输出：日期(20241129、...、20241219、汇总)、pv、uv"

sql_59："统计：20250111-20250124时间区间内，幻境使者活动抽奖用户第X次触发赠送后，这些用户的总抽奖次数\n输出：第X次触发,触发用户数,用户总抽奖次数"


# 新问题
Q: {{
query
}}

A: 先思考，再只输出最终一行：
"""


def _parse_sql_ids(response: dict):
    """
    仅提取“sql_ids = [xx,xx,xx]”中的数字，返回 List[int]。
    更健壮的解析：允许空白、换行，并过滤非数字字符。
    """
    content = response.get('content', '')
    # 先定位 sql_ids = [ ... ] 片段
    m = re.search(r"sql_ids\s*=\s*\[(.*?)\]", content, flags=re.IGNORECASE | re.DOTALL)
    inner = m.group(1) if m else content
    # 提取所有整数
    nums = re.findall(r"\d+", inner)
    # 去重并保持顺序
    seen = set()
    ids = []
    for n in nums:
        if n not in seen:
            seen.add(n)
            ids.append(int(n))
        if len(ids) == 3:
            break
    return ids

def get_goldensql_references(query: str, config: dict):
    formatted_prompt = prompt.format(
        query=query,
    )
    response = call_sse(config['app_key'], '', formatted_prompt)
    sql_ids = _parse_sql_ids(response)
    print(f"Selected goldensql references: {sql_ids}")
    return sql_ids